<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>龍榻餘燼：權色迷局</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* 全局設定 */
        body {
            font-family: "Noto Serif TC", serif;
            background-color: #000;
            margin: 0;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        #stage {
            position: relative;
            width: 100vw;
            height: 56.25vw;
            max-height: 100vh;
            max-width: 177.78vh;
            margin: auto;
            background-color: #1a202c;
            overflow: hidden;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
        }

        #app-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100vw;
            height: 100vh;
            background: #0f0f0f;
            background-image: radial-gradient(#2d2d2d 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .bg-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            transition: opacity 1s ease-in-out;
            z-index: 1;
        }

        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: auto;
            cursor: pointer;
        }

        .dialogue-box {
            position: absolute;
            bottom: 5%;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            height: 32%;
            background: linear-gradient(to bottom, rgba(10,10,10,0.85), rgba(0,0,0,0.95));
            border: 1px solid #4a5568;
            border-top: 3px solid #8c1d40;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            padding: 25px 35px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.9);
            backdrop-filter: blur(4px);
            pointer-events: none; 
        }

        .name-tag {
            position: absolute;
            top: -34px;
            left: 20px;
            background: linear-gradient(to right, #8c1d40, #5a1025);
            color: #FFD700;
            padding: 5px 35px;
            font-size: 1.6rem;
            font-weight: bold;
            border-radius: 4px 4px 0 0;
            border: 1px solid #FFD700;
            border-bottom: none;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.5);
            min-width: 140px;
            text-align: center;
            letter-spacing: 3px;
            font-family: "Noto Serif TC", serif;
        }

        .dialogue-text {
            color: #e2e8f0;
            font-size: 1.35rem;
            line-height: 1.8;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.8);
            height: 100%;
            overflow-y: auto;
            padding-right: 15px;
        }

        .dialogue-text::-webkit-scrollbar { width: 5px; }
        .dialogue-text::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 5px; }

        .next-cursor {
            position: absolute;
            bottom: 20px;
            right: 30px;
            width: 0; 
            height: 0; 
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 15px solid #FFD700;
            animation: bounce 1s infinite;
            display: none;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); opacity: 0.6; }
            50% { transform: translateY(8px); opacity: 1; }
        }

        .choices-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 20;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 1.5rem;
            pointer-events: auto;
            backdrop-filter: blur(5px);
            cursor: default;
        }

        .choice-btn {
            background: linear-gradient(90deg, transparent, #1a202c, transparent);
            border: 1px solid #718096;
            border-left: 4px solid #8c1d40;
            border-right: 4px solid #8c1d40;
            color: #cbd5e0;
            padding: 1.2rem 4rem;
            font-size: 1.3rem;
            min-width: 60%;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .choice-btn:hover {
            background: linear-gradient(90deg, transparent, #8c1d40, transparent);
            transform: scale(1.05);
            border-color: #FFD700;
            color: #FFD700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
        }

        .sys-menu {
            position: absolute;
            top: 0;
            right: 0;
            padding: 15px;
            display: flex;
            gap: 12px;
            pointer-events: auto;
            z-index: 30;
        }

        .sys-btn {
            background: rgba(0,0,0,0.6);
            color: #a0aec0;
            border: 1px solid #4a5568;
            padding: 6px 15px;
            font-size: 0.95rem;
            cursor: pointer;
            border-radius: 2px;
            transition: all 0.2s;
            font-family: sans-serif;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .sys-btn:hover { background: #8c1d40; color: white; border-color: #FFD700; }

        #cover-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 50;
            background-color: #1a202c;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-size: cover;
            background-position: center;
        }

        .title-main {
            font-size: 5.5rem;
            color: #FFD700;
            text-shadow: 0 0 30px rgba(140, 29, 64, 0.8), 2px 2px 0 #000;
            margin-bottom: 0.5rem;
            font-weight: bold;
            letter-spacing: 10px;
            font-family: "Noto Serif TC", serif;
        }

        #log-window {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 40;
            display: none;
            flex-direction: column;
            padding: 50px;
            pointer-events: auto;
        }

        .log-content { flex-grow: 1; overflow-y: auto; color: #a0aec0; padding-right: 20px; font-size: 1.1rem; }
        .log-entry { margin-bottom: 20px; border-bottom: 1px solid #2d3748; padding-bottom: 15px; }
        .log-name { color: #8c1d40; font-weight: bold; margin-bottom: 8px; font-size: 1.2rem; }

        .toast {
            position: absolute;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(to right, #8c1d40, #b83280);
            color: #fff;
            padding: 12px 40px;
            border-radius: 30px;
            font-weight: bold;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.5s;
            pointer-events: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            letter-spacing: 1px;
        }

        /* 章節標題動畫 */
        #chapter-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 25;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: #FFD700;
            opacity: 0;
            transition: opacity 1s;
            pointer-events: none;
        }
        .chapter-text { 
            font-size: 3.5rem; 
            font-weight: bold; 
            letter-spacing: 0.8rem; 
            text-shadow: 0 0 20px #8c1d40; 
            border-top: 2px solid #8c1d40;
            border-bottom: 2px solid #8c1d40;
            padding: 20px 0;
        }

        @media (max-width: 768px) {
            .dialogue-box { height: 40%; width: 95%; bottom: 10px; padding: 20px; }
            .name-tag { font-size: 1.2rem; top: -25px; padding: 2px 20px; }
            .dialogue-text { font-size: 1.1rem; }
            .title-main { font-size: 3rem; text-align: center; }
            .choice-btn { min-width: 85%; padding: 1rem; font-size: 1.1rem; }
            .chapter-text { font-size: 2rem; letter-spacing: 0.3rem; }
            .sys-menu { padding: 10px; gap: 8px; }
            .sys-btn { padding: 4px 10px; font-size: 0.8rem; }
        }
    </style>
</head>
<body>

<div id="app-wrapper">
    <div id="stage">
        <div id="toast" class="toast">遊戲已儲存</div>

        <div id="bg-back" class="bg-layer" style="opacity: 0;"></div>
        <div id="bg-front" class="bg-layer" style="opacity: 1;"></div>

        <!-- 章節過場 -->
        <div id="chapter-overlay">
            <div class="chapter-text" id="chapter-text">第一章</div>
        </div>

        <div id="cover-screen">
            <h1 class="title-main">龍榻餘燼</h1>
            <h2 class="text-2xl text-gray-400 mb-12 tracking-[1em] uppercase">權色迷局</h2>
            <div class="flex flex-col gap-5 w-full items-center">
                <button onclick="startGame()" class="px-12 py-4 bg-gradient-to-r from-red-900 to-red-800 text-yellow-100 border border-yellow-700 rounded shadow-[0_0_15px_rgba(140,29,64,0.5)] hover:shadow-[0_0_25px_rgba(255,215,0,0.4)] text-2xl transition transform hover:scale-105 tracking-widest">開始遊戲</button>
                <button onclick="loadGame()" class="px-12 py-3 bg-gray-900 text-gray-400 border border-gray-700 rounded hover:bg-gray-800 text-xl transition tracking-widest">讀取進度</button>
            </div>
            <div class="absolute bottom-5 text-gray-600 text-sm font-sans tracking-wider">深度劇情版 v4.0 (圖片替換版)</div>
        </div>

        <div id="ui-layer" style="display: none;" onclick="handleInteraction(event)">
            <div class="sys-menu" onclick="event.stopPropagation()">
                <button class="sys-btn" onclick="toggleLog()">Log</button>
                <button class="sys-btn" onclick="saveGame()">Save</button>
                <button class="sys-btn" onclick="loadGameInGame()">Load</button>
                <button class="sys-btn" onclick="toggleAuto()" id="btn-auto">Auto</button>
                <button class="sys-btn" onclick="returnToCover()">Title</button>
            </div>

            <div class="dialogue-box" id="dialogue-box">
                <div class="name-tag" id="name-tag" style="display: none;"></div>
                <div class="dialogue-text" id="dialogue-text"></div>
                <div class="next-cursor" id="next-cursor"></div>
            </div>

            <div class="choices-overlay" id="choices-overlay"></div>
        </div>

        <div id="log-window">
            <div class="flex justify-between items-center mb-6 border-b border-gray-600 pb-4">
                <h2 class="text-3xl text-yellow-600 font-bold tracking-widest">劇情回顧</h2>
                <button onclick="toggleLog()" class="text-gray-300 hover:text-white px-5 py-2 border border-gray-500 rounded hover:bg-gray-800 transition">關閉</button>
            </div>
            <div class="log-content" id="log-content"></div>
        </div>
    </div>
</div>

<script>
    /* --- 輔助函數 --- */
    const bg = (color, text) => `https://i.postimg.cc/3JCBX98P/BL遊戲圖_(11).png`;

    
    const coverBgImage = 'https://i.postimg.cc/3JCBX98P/BL遊戲圖_(11).png';

    /* --- 完整故事數據 --- */
    const story = [
        // --- 序章：風雨欲來 ---
        {
            id: 'intro_prologue',
            type: 'chapter', title: '序章：罪臣之後',
            
            background: 'https://i.postimg.cc/j5hpWpNx/BL遊戲圖_(13).png',
            text: '傅家世代忠良，一門清貴，曾是京城中最令人豔羨的門第。然而，一紙「結黨營私」的彈劾，如驚雷般劈碎了傅家百年的榮光。',
            nextScene: 'intro_prologue2'
        },
        {
            id: 'intro_prologue2',
            
            background: 'https://i.postimg.cc/0QCT6Tm8/BL遊戲圖_(17).png',
            text: '父兄流放，家產抄沒。曾經鮮衣怒馬的少年郎傅錦庭，一夜之間跌落塵泥。但命運的嘲弄並未就此停止，因為他的這張臉，因為那雙即使在絕境中依然清亮的眼，他被那位高高在上的帝王選中了。',
            nextScene: 'intro_emp'
        },

        // --- 人物介紹 ---
        {
            id: 'intro_emp',
            
            background: 'https://i.postimg.cc/8kLBGw6M/BL遊戲圖.png',
            text: '**皇帝：**\n他，是九五之尊，是萬民景仰的蒼穹。然而，在那龍袍之下，隱藏著的卻是一片深不可測的慾海。對於錦庭，他看見的不僅是一個臣子，更是一面鏡子，映照出他內心深處那份對極致佔有與征服的渴望。',
            nextScene: 'intro_jin'
        },
        {
            id: 'intro_jin',
            
            background: 'https://i.postimg.cc/262c7w7B/BL遊戲圖_(1).png',
            text: '**傅錦庭：**\n他被迫進入這座金碧輝煌的牢籠，成為帝王龍榻上的玩物。但他從未真正臣服。他，是蟄伏的龍，等待著破繭成蝶的那一刻，將所有的慾望與野心，化為燎原的烈火。',
            choices: [{ text: '進入故事', nextScene: 'chapter1_start' }]
        },

        // --- 第一章：龍榻初夜 ---
        {
            id: 'chapter1_start',
            type: 'chapter', title: '第一章：龍榻初夜',
            
            background: 'https://i.postimg.cc/zvvdtgxF/BL遊戲圖_(2).png',
            text: '紫宸殿內，金磚漫地，映照著搖曳的燭火。空氣中瀰漫著龍涎香與沉水香交織的氣息，甜膩得令人窒息。錦庭跪在殿中，膝下的涼意穿透衣料，直抵骨髓，提醒著他如今卑微的身份。',
            nextScene: 'ch1_gaze'
        },
        {
            id: 'ch1_gaze',
            
            background: 'https://i.postimg.cc/DZc9W9sm/BL遊戲圖_(16).png',
            text: '高座之上，書卷翻動的聲音戛然而止。那道目光如有實質，沿著他的脊背緩緩遊走，像是獵人在審視即將入口的獵物，帶著一種令人戰慄的評估意味。',
            nextScene: 'ch1_speak'
        },
        {
            id: 'ch1_speak',
            
            background: 'https://i.postimg.cc/R0LsGc0j/BL遊戲圖_(15).png',
            text: '**皇帝：**\n「抬起頭來。」\n\n聲音不辨喜怒，卻帶著千鈞之重，在空曠的大殿中迴盪。',
            nextScene: 'ch1_face'
        },
        {
            id: 'ch1_face',
            
            background: 'https://i.postimg.cc/T3mH58vP/BL遊戲圖_(14).png',
            text: '錦庭緩緩抬頭，對上那雙深不見底的眼眸。帝王龍袍半敞，神色慵懶，卻難掩眉宇間的戾氣與威嚴。在觸及錦庭視線的那一瞬，那份威嚴化作了深潭般的玩味。',
            nextScene: 'ch1_come'
        },
        {
            id: 'ch1_come',
            
            background: 'https://i.postimg.cc/d1vMVs7J/BL遊戲圖_(18).png',
            text: '**皇帝：**\n「都說傅家兒郎清貴無雙，如今看來，這雙眼睛裡的倔強，倒比這張臉更有趣。」\n\n皇帝招了招手，語氣輕柔得令人心悸。\n\n**皇帝：**\n「錦庭，過來。」',
            nextScene: 'ch1_move'
        },
        {
            id: 'ch1_move',
            
            background: 'https://i.postimg.cc/BvFrcLWC/BL遊戲圖_(19).png',
            text: '錦庭起身，每靠近一步，衣襟間便湧動起一股難以言喻的火熱氣息。他感到一陣眩暈，那不僅是身體的本能恐懼，更是靈魂深處被觸動的戰慄。這是他從未涉足過的領域，危險而誘人。',
            nextScene: 'ch1_touch'
        },
        {
            id: 'ch1_touch',
            
            background: 'https://i.postimg.cc/TY7vRvqT/BL遊戲圖_(21).png',
            text: '行至榻前，一隻修長有力的手猛地扣住了他的手腕。拇指上冰冷的玉扳指硌得他生疼，但那掌心的熱度卻似要將他灼傷。天旋地轉間，他已被拉入那個充滿侵略氣息的懷抱。',
            nextScene: 'ch1_whisper'
        },
        {
            id: 'ch1_whisper',
            
            background: 'https://i.postimg.cc/TY7vRvqr/BL遊戲圖_(22).png',
            text: '**皇帝：**\n「今夜，你便是朕的心頭火，怎能輕易逃脫？」\n\n熱氣噴灑在耳畔，如同最蠱惑的咒語。皇帝的手指緩緩收緊，彷彿要將他嵌入骨血之中。',
            nextScene: 'ch1_choice'
        },
        {
            id: 'ch1_choice',
            
            background: 'https://i.postimg.cc/15C191cw/BL遊戲圖_(20).png',
            text: '錦庭的身體猶如被烈焰包裹，那份羞辱與快感奇異地交織在一起。在這權力的絕對壓制下，他的心境發生了劇烈的震盪。',
            choices: [
                { text: '默默承受，以靜制動', nextScene: 'ch1_res_silent' },
                { text: '暗記屈辱，誓報此仇', nextScene: 'ch1_res_grudge' },
                { text: '情愫初動，難以自持', nextScene: 'ch1_res_infatuation' }
            ]
        },
        // 第一章分支
        {
            id: 'ch1_res_silent',
            
            background: 'https://i.postimg.cc/B6GdhSsB/dreamina_2026_02_07_9134_紫宸殿內燭火微弱_龍榻半掩紗帳_金紅色燈光照映二人身影交疊_皇帝外袍滑落_露出胸.jpg',
            text: '錦庭閉上眼，身體在帝王的掌控下不再僵硬，卻也沒有迎合。他像是一塊被投入深潭的玉石，任由水波將他包裹。',
            nextScene: 'ch1_res_silent2'
        },
        {
            id: 'ch1_res_silent2',
            
            background: 'https://i.postimg.cc/XvLZBB1R/dreamina_2026_02_08_6248_中國古代宮廷夜景_御書房內_昏暗宮燈與冷月光交錯_一名白衣年輕臣子單膝跪地_低眉.jpg',
            text: '（這不是結束，這只是開始。）\n他在心中默唸。這份沉默並非屈服，而是他深藏不露的盤算。他要記住這種無力感，將其化為未來反擊的籌碼。皇帝似乎對他的順從感到無趣，卻又對他的隱忍更加著迷。',
            nextScene: 'chapter2_start'
        },
        {
            id: 'ch1_res_grudge',
            
            background: 'https://i.postimg.cc/Zq4BqxjZ/dreamina_2026_02_08_1759_中國古代宮廷室內_暗紅色調籠罩_披髮年輕男子白色古裝滑落露出胸膛_上半身特寫_一.jpg',
            text: '指甲深深掐入掌心，疼痛讓他保持清醒。皇帝的每一次觸碰，都像烙鐵般在他肌膚上留下恥辱的印記。',
            nextScene: 'ch1_res_grudge2'
        },
        {
            id: 'ch1_res_grudge2',
            
            background: 'https://i.postimg.cc/N0Dy22CW/dreamina_2026_02_08_8216_中國古代宮廷夜晚_暗紅色調籠罩的龍榻場景_血色帷帳垂落_披髮年輕男子身穿白色古裝.jpg',
            text: '他被迫承受著這份看似恩寵實則侵犯的熱情，眼底卻燃燒起復仇的火焰。這座宮殿，這張龍榻，終將成為埋葬這段屈辱的墳墓。',
            nextScene: 'chapter2_start'
        },
        {
            id: 'ch1_res_infatuation',
            
            background: 'https://i.postimg.cc/VNgS00ZT/dreamina_2026_02_08_2900_中國古代宮廷內室_紫色迷離色調_柔和燭光與香霧交織_披髮年輕男子身穿白色古裝滑落.jpg',
            text: '在皇帝那不可抗拒的威嚴下，錦庭的心防竟出現了一絲裂痕。那份霸道中的溫柔，像是一種致命的毒藥，讓他有些迷醉。',
            nextScene: 'ch1_res_infatuation2'
        },
        {
            id: 'ch1_res_infatuation2',
            
            background: 'https://i.postimg.cc/LsDqgg0R/dreamina_2026_02_08_9609_中國古代宮廷內室夜景_紫色迷離色調_柔和燭光與香霧瀰漫_披髮年輕男子身穿白色古裝.jpg',
            text: '他開始回應這份熾熱，情感在理智崩塌的邊緣試探。或許，沉淪於這份帝王的恩澤，也是一種解脫？他能感覺到皇帝的動作因此變得更加狂熱與憐愛。',
            nextScene: 'chapter2_start'
        },

        // --- 第二章：玉階伏雨 ---
        {
            id: 'chapter2_start',
            type: 'chapter', title: '第二章：玉階伏雨',
            
            background: 'https://i.postimg.cc/fyyH298m/BL遊戲圖_(3).png',
            text: '晨曦微透，一縷金光透過窗櫺，輕柔地灑落在紫宸殿的龍榻之上。錦庭從那溫熱的懷抱中緩緩起身，渾身的酸痛無聲訴說著昨夜的荒唐。他看著身邊熟睡的帝王，心情複雜難辨。',
            nextScene: 'ch2_wake'
        },
        {
            id: 'ch2_wake',
            
            background: 'https://i.postimg.cc/tgbyLFCs/BL遊戲圖_(27).png',
            text: '皇帝不知何時已醒，正側身支著頭，髮絲散亂，饒有興致地看著他。那目光不似昨夜狂亂，卻多了一份清醒的審視，彷彿在看一件新得的珍寶。',
            nextScene: 'ch2_dialogue'
        },
        {
            id: 'ch2_dialogue',
            
            background: 'https://i.postimg.cc/DwLnjxhS/BL遊戲圖_(23).png',
            text: '皇帝修長的手指輕輕滑過錦庭的肩膀，引得他一陣戰慄。\n\n**皇帝：**\n「昨夜風急雨驟，愛卿睡得可好？」\n\n語氣帶著一絲慵懶與玩味，卻又直擊心底。',
            nextScene: 'ch2_reply'
        },
        {
            id: 'ch2_reply',
            
            background: 'https://i.postimg.cc/VknmGKwW/BL遊戲圖_(26).png',
            text: '錦庭垂眸，竭力穩住心神。\n\n**傅錦庭：**\n「臣……既敬且懼。」\n\n**皇帝：**\n「懼？」\n皇帝輕笑一聲，指尖挑起他的下巴，「往後日子還長，你得習慣。」',
            nextScene: 'ch2_decree'
        },
        {
            id: 'ch2_decree',
            
            background: 'https://i.postimg.cc/K8Bxq0b5/BL遊戲圖_(25).png',
            text: '未幾，傳旨太監尖細的嗓音響徹殿外——\n「奉天承運，皇帝詔曰：傅氏錦庭，才德兼備，特封為奉儀郎，賜居紫宸殿側殿。」',
            nextScene: 'ch2_reaction'
        },
        {
            id: 'ch2_reaction',
            
            background: 'https://i.postimg.cc/XYd4HsW8/BL遊戲圖_(24).png',
            text: '奉儀郎……一個在朝臣眼中意味不明，在後宮眼中卻意味著盛寵的頭銜。這份突如其來的「榮寵」，如同深淵般將他吞噬，將他徹底推向了風口浪尖。宮牆內的竊竊私語，早已將他淹沒。',
            choices: [
                { text: '順從受寵，韜光養晦', nextScene: 'ch2_res_obey' },
                { text: '暗懷異志，窺探機密', nextScene: 'ch2_res_plot' },
                { text: '真情漸生，甘願沉淪', nextScene: 'ch2_res_love' }
            ]
        },
        // 第二章分支
        {
            id: 'ch2_res_obey',
            
            background: 'https://i.postimg.cc/RVMXsyC4/dreamina_2026_02_11_9193_中國古代宮廷長廊_長廊筆直延伸_紅柱整齊排列_光線均勻柔和_身穿錦袍披髮年輕男子.jpg',
            text: '錦庭跪地謝恩，面上看不出悲喜。他選擇了順從，如同深宮中一朵悄然綻放的夜來香。他深知，在羽翼未豐之前，順從是最好的偽裝。',
            nextScene: 'chapter3_start'
        },
        {
            id: 'ch2_res_plot',
            
            background: 'https://i.postimg.cc/CLZCrDfn/dreamina_2026_02_11_8278_中國古代宮廷陰影場景_強烈側光形成明暗對比_披髮年輕男子半邊臉在光中半邊臉在陰影.jpg',
            text: '錦庭謝恩的聲音平靜無波，袖中的手卻緊握成拳。這份封賞不過是帝王施予的項圈。他決定利用這個身份，作為窺探權力核心的鑰匙。',
            nextScene: 'chapter3_start'
        },
        {
            id: 'ch2_res_love',
            
            background: 'https://i.postimg.cc/hPJ8Zx7d/dreamina_2026_02_11_9789_中國古代紫宸殿前傍晚場景_暖金與柔紫色調_夕陽餘暉灑在宮殿長階上_兩名男子並肩站.jpg',
            text: '錦庭看著皇帝的側臉，心中五味雜陳。留宿紫宸殿，意味著他將與這個男人日夜相對。不知為何，他心中竟隱隱生出一絲期待。',
            nextScene: 'chapter3_start'
        },

        // --- 第三章：暗潮洶湧 ---
        {
            id: 'chapter3_start',
            type: 'chapter', title: '第三章：暗潮洶湧',
            
            background: 'https://i.postimg.cc/bJ3C9T9v/BL遊戲圖_(4).png',
            text: '數月匆匆，皇帝的寵愛如同燎原之火，毫無保留地席捲了錦庭全身。然而，真正的試煉才剛剛開始。\n\n黃昏時分，御書房內。',
            nextScene: 'ch3_work'
        },
        {
            id: 'ch3_work',
            
            background: 'https://i.postimg.cc/X7VQHmNV/dreamina_2026_02_11_8359_中國古代宮廷書房_龍案上堆滿奏摺_年輕披髮男子在一旁研墨_手部特寫_墨汁在硯台中.jpg',
            text: '錦庭立於案側，為皇帝研墨。墨香氤氳，卻掩蓋不住空氣中的肅殺。皇帝批閱著奏摺，眉頭微鎖，氣氛凝重。突然，皇帝將一本奏摺扔在案上，發出「啪」的一聲脆響。',
            nextScene: 'ch3_test'
        },
        {
            id: 'ch3_test',
            
            background: 'https://i.postimg.cc/JzS3L28n/dreamina_2026_02_11_5744_中國古代宮廷書房_龍案上散落一卷奏摺_奏摺封皮微開帶紅色印章_年輕披髮男子雙手懸.jpg',
            text: '**皇帝：**\n「錦庭，你來看看這本。」\n\n錦庭一驚，後宮不得干政，這是鐵律。他猶豫片刻，在皇帝不容置喙的目光下，雙手捧起奏摺。',
            nextScene: 'ch3_read'
        },
        {
            id: 'ch3_read',
            
            background: 'https://i.postimg.cc/zvkpDS7Y/dreamina_2026_02_11_9743_中國古代宮廷書房內_第一人稱閱讀視角_雙手展開奏摺_奏摺上寫有彈劾王太傅結黨營私.jpg',
            text: '展開奏摺，錦庭的瞳孔猛地收縮。那是彈劾前朝老臣王太傅結黨營私的摺子，字字誅心，意欲置之死地。而那位王太傅，不僅是朝中清流領袖，更是錦庭昔日的恩師。',
            nextScene: 'ch3_king_ask'
        },
        {
            id: 'ch3_king_ask',
            
            background: 'https://i.postimg.cc/qqC09qxs/dreamina_2026_02_11_2429_中國古代宮廷書房_皇帝坐於龍案後_略低角度構圖_皇帝微微前傾_目光銳利平靜卻充滿.jpg',
            text: '**皇帝：**\n「朕記得，你少時曾受教於王太傅門下。你覺得，朕該殺他嗎？」\n\n皇帝的聲音平靜，卻藏著致命的殺機。',
            nextScene: 'ch3_tension'
        },
        {
            id: 'ch3_tension',
            
            background: 'https://i.postimg.cc/wBynFZq0/dreamina_2026_02_12_3627_中國古代宮廷書房近景_燭火微光下_皇帝修長的手輕撫年輕披髮男子後頸_畫面聚焦頸側.jpg',
            text: '這是一個試探，也是一個陷阱。若求情，便是結黨；若不救，便是薄倖。\n\n錦庭感到背後一陣寒意，皇帝的手不知何時已撫上他的後頸，輕輕摩挲，像是在安撫一隻受驚的貓，又像是在尋找下口的動脈。',
            choices: [
                { text: '順著帝意，明哲保身', nextScene: 'ch3_res_sink' },
                { text: '暗中回護，以退為進', nextScene: 'ch3_res_soft' },
                { text: '大膽直言，博取信任', nextScene: 'ch3_res_plot' }
            ]
        },
        // 第三章分支
        {
            id: 'ch3_res_sink',
            
            background: 'https://i.postimg.cc/ZqBXj2bH/dreamina_2026_02_12_2980_中國古代宮廷書房_氣氛冷酷壓抑_皇帝坐於龍案後神情難測_年輕披髮男子恭敬回話_面.jpg',
            text: '**傅錦庭：**\n「雷霆雨露，俱是君恩。此人既有結黨之嫌，陛下聖裁即可。臣如今身在內廷，不敢妄議朝政。」\n\n他選擇了犧牲恩師，保全自己。',
            nextScene: 'ch3_res_sink2'
        },
        {
            id: 'ch3_res_sink2',
            
            background: 'https://i.postimg.cc/3w4z9V8p/dreamina_2026_02_12_8524_中國古代宮廷書房場景_皇帝將年輕披髮男子拉入懷中輕笑_眼神滿意而掌控_氣氛壓抑而.jpg',
            text: '皇帝聞言，眼中閃過一絲滿意，手上的力道鬆了幾分，將他拉入懷中輕笑：「還是你懂朕的心意。那便……賜死吧。」錦庭低著頭，指甲掐進肉裡，鮮血淋漓。',
            nextScene: 'chapter4_start'
        },
        {
            id: 'ch3_res_soft',
            
            background: 'https://i.postimg.cc/nLjNTgFD/dreamina_2026_02_12_2951_中國古代宮廷書房場景_月白與淡金色調_氣氛柔和卻帶有策略感_皇帝與年輕披髮男子靠.jpg',
            text: '**傅錦庭：**\n「臣以為，殺之容易，但若能查清黨羽，一網打盡，或許更有利於陛下江山穩固。況且王太傅年事已高，留他一命以示皇恩浩蕩，更能收買人心。」',
            nextScene: 'ch3_res_soft2'
        },
        {
            id: 'ch3_res_soft2',
            
            background: 'https://i.postimg.cc/NjPW6Bc2/dreamina_2026_02_12_1808_中國古代宮廷書房場景_暖金與青墨色調_氣氛沉靜而帶策略張力_皇帝微微前傾思考後伸.jpg',
            text: '他避重就輕，試圖為恩師爭取一線生機。皇帝深深看了他一眼，手指點了點他的眉心：「你倒是心細。罷了，便依你，流放三千里。」',
            nextScene: 'chapter4_start'
        },
        {
            id: 'ch3_res_plot',
            
            background: 'https://i.postimg.cc/y8rwmsHR/dreamina_2026_02_12_7321_中國古代宮廷大殿或書房場景_深墨黑與暗金色調_氣氛緊張壓抑_皇帝坐於高位神情沉冷.jpg',
            text: '**傅錦庭：**\n「臣以為不可殺！此奏摺雖言之鑿鑿，卻無實證。陛下若因流言殺害三朝元老，恐寒天下士子之心，也損了陛下聖德。」\n\n他抬起頭，目光灼灼，直視天顏。',
            nextScene: 'ch3_res_plot2'
        },
        {
            id: 'ch3_res_plot2',
            
            background: 'https://i.postimg.cc/Mprh7qS0/dreamina_2026_02_12_1857_中國古代御書房全景_氣氛從壓抑轉為豪氣_皇帝站起或仰首大笑_袖袍揚起_神情張揚而.jpg',
            text: '這是一步險棋，賭的是皇帝的氣度。御書房內死寂一片。許久，皇帝突然大笑：「好！朕就喜歡你這股不怕死的勁。傳朕旨意，重審此案！」',
            nextScene: 'chapter4_start'
        },


        // --- 第四章：巔峰前夜 ---
        {
            id: 'chapter4_start',
            type: 'chapter', title: '第四章：巔峰前夜',
            
            background: 'https://i.postimg.cc/J7sv5fSC/BL遊戲圖_(5).png',
            text: '窗外雷聲滾滾，一場暴雨即將傾盆。寢宮內的氣氛比窗外更為壓抑。今夜，是決定傅家命運，也是決定錦庭與皇帝關係走向的關鍵之夜。',
            nextScene: 'ch4_bed'
        },
        {
            id: 'ch4_bed',
            
            background: 'https://i.postimg.cc/HkPfwdg5/dreamina_2026_02_12_4721_中國古代宮廷龍榻場景_氣氛強烈動盪_紗帳晃動_錦被凌亂_人物半身構圖不露骨_皇帝.jpg',
            text: '龍榻之上，皇帝的動作比以往任何一次都要粗暴急切。他彷彿要通過這種方式，確認錦庭的存在，確認這份掌控權。錦庭在顛簸中，看到了皇帝眼底深處的一抹不安。',
            nextScene: 'ch4_control'
        },
        {
            id: 'ch4_control',
            
            background: 'https://i.postimg.cc/FzPsFLkT/dreamina_2026_02_13_1912_中國古代宮廷夜晚場景_深紅與暗金色調_極近距離雙人特寫_皇帝強勢抬起年輕披髮男子.jpg',
            text: '**皇帝：**\n「錦庭，看著朕。」\n\n皇帝強迫他抬起頭，兩人的呼吸交纏在一起。皇帝的眼中燃燒著兩簇火焰，那是慾望，也是恐懼。\n「朕要你記住，這是你一生中最無法抗拒的夜晚。」',
            nextScene: 'ch4_climax'
        },
        {
            id: 'ch4_climax',
            
            background: 'https://i.postimg.cc/nL8VLZrd/dreamina_2026_02_13_5394_中國古代宮廷夜晚場景_深紅與金橙色調_燃燒的紅燭特寫_蠟油緩緩流下_火焰劇烈晃動.jpg',
            text: '隨著這句話，一股濃烈的熱浪席捲而來。錦庭的身體在極致的感官衝擊下輕微顫抖，但他的心卻在這一刻變得異常清醒。',
            nextScene: 'ch4_thought'
        },
        {
            id: 'ch4_thought',
            
            background: 'https://i.postimg.cc/W1qbjtpc/dreamina_2026_02_13_5026_中國古代宮廷夜晚場景_冷月銀與暗金色調_雙人心理對峙構圖_前景皇帝半側臉特寫_髮.jpg',
            text: '他看出了皇帝眼底深處的那一絲脆弱——這位擁有天下的君王，竟然在害怕失去他。這是最後的博弈，你的選擇將決定所有人的命運。',
            choices: [
                { text: '暫時屈服，謀取皇權 (結局A)', nextScene: 'ending_seize_start' },
                { text: '忍辱負重，最終失敗 (結局B)', nextScene: 'ending_fail_start' },
                { text: '主動挑逗，情權雙收 (結局C)', nextScene: 'ending_union_start' },
                { text: '心灰意冷，尋機隱退 (結局D)', nextScene: 'ending_withdraw_start' }
            ]
        },

        // --- 結局：奪權稱帝 (孤家寡人) ---
        {
            id: 'ending_seize_start',
            type: 'chapter', title: '結局：奪權稱帝',
            
            background: 'https://i.postimg.cc/pdNVdxr4/dreamina_2026_02_13_7230_中國古代金鑾殿宏大場景_高聳宮殿梁柱與龍紋裝飾_皇帝端坐龍椅威嚴肅穆_年輕披髮男.jpg',
            text: '錦庭選擇了順從，將野心藏於最深的溫柔之中。日復一日，他成為了皇帝最信任的影子。他利用這份信任，編織了一張巨大的網，將朝堂重臣一一籠絡。',
            nextScene: 'ending_seize_2'
        },
        {
            id: 'ending_seize_2',
            
            background: 'https://i.postimg.cc/Df5zPtps/dreamina_2026_02_13_4473_中國古風宮廷BL風格_紫宸殿內殿_深夜燭光_皇帝中毒虛弱坐於龍椅_白玉茶杯打翻.jpg',
            text: '五年後，宮變那日，紫宸殿的燈火徹夜通明。當皇帝喝下那杯錦庭親手奉上的「安神茶」，毒發吐血時，眼中沒有憤怒，只有震驚與心碎。\n\n**皇帝：**\n「連你……也要背叛朕嗎？」',
            nextScene: 'ending_seize_3'
        },
        {
            id: 'ending_seize_3',
            
            background: 'https://i.postimg.cc/Vs4NW3ZH/dreamina_2026_02_13_1040_中國古風宮廷BL風格_金鑾殿長階_青年帝王背影_身穿明黃龍袍_龍紋華麗細節_低角.jpg',
            text: '錦庭沒有回答，只是輕輕合上了皇帝的雙眼。他身披龍袍，踏著愛人的屍骨，一步步走上金鑾殿巔，受萬人朝拜。權力握在手中的觸感冰冷而真實。',
            nextScene: 'ending_seize_4'
        },
        {
            id: 'ending_seize_4',
            
            background: 'https://i.postimg.cc/T1kY2D5B/dreamina_2026_02_13_9186_中國古風宮廷BL風格_空蕩金鑾殿_孤獨帝王坐在龍椅上_夜晚冷月光照入殿內_明黃龍.jpg',
            text: '他開創了盛世，史稱中興之主。只是在無數個深夜，他仍會夢見那雙曾滿含愛意看著他的眼睛。他贏了天下，卻輸了唯一能喚他乳名的人。高處不勝寒，此生，只剩孤家寡人。\n\n【結局達成：孤家寡人】',
            choices: [{ text: '重新開始', nextScene: 'intro_prologue' }]
        },

        // --- 結局：權謀失敗 (一場空夢) ---
        {
            id: 'ending_fail_start',
            type: 'chapter', title: '結局：權謀失敗',
            
            background: 'https://i.postimg.cc/BbcqPmZm/dreamina_2026_02_14_5155_中國古風宮廷BL風格_古代天牢場景_陰暗潮濕石牢_鐵窗月光照射_青年男子坐在牢中.jpg',
            text: '錦庭低估了帝王的深沉。他以為自己做得天衣無縫，卻不知他的一舉一動，早就在皇帝的監控之下。他頻繁的暗中布局、與權臣的私下接觸，終究未能逃過皇帝的鷹眼。',
            nextScene: 'ending_fail_2'
        },
        {
            id: 'ending_fail_2',
            
            background: 'https://i.postimg.cc/5Nb9WWpm/dreamina_2026_02_14_2621_中國古風宮廷BL風格_風雨夜晚宮廷場景_皇帝冷漠背影_玄紫龍袍_禁衛軍包圍偏殿.jpg',
            text: '一個風雨交加的夜晚，禁衛軍包圍了偏殿。沒有審判，沒有辯解，只有皇帝冰冷的背影。\n\n**皇帝：**\n「朕給過你機會，是你自己不珍惜。朕給你的，朕也能收回。」',
            nextScene: 'ending_fail_3'
        },
        {
            id: 'ending_fail_3',
            
            background: 'https://i.postimg.cc/J7b7Fz3B/dreamina_2026_02_14_7020_中國古風宮廷BL風格_古代邊塞荒漠場景_蒼涼風沙_孤獨男子站在城牆遠望_粗布衣袍.jpg',
            text: '他被廢去所有封號，貶為庶民，流放千里。在邊塞淒涼的風沙中，他日漸蒼老。每當夜深人靜，他回想起紫宸殿的暖香與那人的體溫，只剩下無盡的悔恨。',
            nextScene: 'ending_fail_4'
        },
        {
            id: 'ending_fail_4',
            
            background: 'https://i.postimg.cc/prY25sVY/dreamina_2026_02_14_2007_中國古風BL風格_雪夜場景_白雪覆蓋地面_凍僵的手緊握玉佩特寫_冷色調夜晚_極簡.jpg',
            text: '最終，他死在了一個無人知曉的冬夜，手裡緊緊攥著的，竟是當年皇帝賞賜的一枚玉佩。權力夢碎，情愛成空，終究是一場空夢。\n\n【結局達成：一場空夢】',
            choices: [{ text: '重新開始', nextScene: 'intro_prologue' }]
        },

        // --- 結局：情深共存 (盛世雙龍) ---
        {
            id: 'ending_union_start',
            type: 'chapter', title: '結局：情深共存',
            
            background: 'https://i.postimg.cc/rmqJgZGh/dreamina_2026_02_15_5835_中國古風BL風格_御花園月夜場景_百花盛開_年輕披髮男子與皇帝側面親吻_花瓣飄落.jpg',
            text: '那一夜，錦庭沒有退縮，而是反客為主，吻上了帝王的唇。他用行動告訴皇帝：我不做你的臣，也不做你的寵，我要做你的伴侶，與你並肩而立的人。',
            nextScene: 'ending_union_2'
        },
        {
            id: 'ending_union_2',
            
            background: 'https://i.postimg.cc/ZnFTvwYx/dreamina_2026_02_14_2307_中國古風宮廷BL風格_御書房夜晚場景_兩名男子(年輕披髮男子與皇帝)深情對視_平.jpg',
            text: '這場豪賭，他贏了。皇帝在他眼中看到了與自己對等的靈魂，那是他孤寂帝王生涯中唯一的慰藉。此後經年，朝堂上他們是君臣，帷幕後他們是愛人。',
            nextScene: 'ending_union_3'
        },
        {
            id: 'ending_union_3',
            
            background: 'https://i.postimg.cc/NF7g2dGp/dreamina_2026_02_14_6097_中國古風宮廷BL風格_御書房議政場景_年輕披髮男子與皇帝並肩站立查看奏摺與地圖.jpg',
            text: '錦庭以過人的才智輔佐皇帝，肅清吏治，開疆拓土。皇帝也給予了他前所未有的信任與尊重，甚至為了他虛設六宮。',
            nextScene: 'ending_union_4'
        },
        {
            id: 'ending_union_4',
            
            background: 'https://i.postimg.cc/VNKrQ7Qh/dreamina_2026_02_15_2104_中國古風宮廷BL風格_年輕披髮男子與皇帝並肩站在高處城樓俯瞰江山_夕陽暮色天空.jpg',
            text: '史書工筆，或許只會記下君臣相得的佳話，卻無人知曉那龍榻之上，兩顆心是如何在權力與慾望的洪流中，緊緊相依，直至白頭。他們共享這萬里江山，也共享這人間煙火。\n\n【結局達成：盛世雙龍】',
            choices: [{ text: '重新開始', nextScene: 'intro_prologue' }]
        },

        // --- 結局：遠離塵囂 (雲淡風輕) ---
        {
            id: 'ending_withdraw_start',
            type: 'chapter', title: '結局：遠離塵囂',
            
            background: 'https://i.postimg.cc/ZnS9z0Kj/dreamina_2026_02_15_2348_中國古代宮廷偏殿_深秋黃昏_冷色調光影_窗外落葉飄落_年輕男子病榻側臥_素白中衣.jpg',
            text: '那夜之後，錦庭大病一場。病中，他看透了權力的虛妄與情愛的沉重。病癒後，他像是變了一個人，不再爭權，也不再諂媚，只剩下一身淡然。',
            nextScene: 'ending_withdraw_2'
        },
        {
            id: 'ending_withdraw_2',
            
            background: 'https://i.postimg.cc/Jnmm1XZp/dreamina_2026_02_15_7859_中國古代皇宮宮門外清晨薄霧_年輕披髮男子身披素色斗篷走下宮階_皇帝站在宮門內側目.jpg',
            text: '皇帝看懂了他眼中的疲憊，或許是最後的一絲憐惜，或許是愛到深處的放手。在一場精心安排的「假死」脫身後，錦庭離開了皇宮，那個困了他半生的地方。',
            nextScene: 'ending_withdraw_3'
        },
        {
            id: 'ending_withdraw_3',
            
            background: 'https://i.postimg.cc/kX8mtws8/dreamina_2026_02_15_4420_中國江南水鄉山水畫風景_青山綠水_小橋流水_白牆黛瓦_竹屋前素衣年輕披髮男子教村.jpg',
            text: '青山綠水間，他隱姓埋名，在江南水鄉過上了採菊東籬下的生活。雖然清貧，卻再無枷鎖。他教村童讀書，看四時花開。',
            nextScene: 'ending_withdraw_4'
        },
        {
            id: 'ending_withdraw_4',
            
            background: 'https://i.postimg.cc/3xd2B4yc/dreamina_2026_02_15_4493_江南水鄉細雨清晨_煙雨朦朧石橋_青灰長衫年輕披髮男子撐油紙傘遠去的背影_水墨山水.jpg',
            text: '偶爾聽聞京中消息，說皇帝性情大變，勤政愛民，只是終生未立后。錦庭聽罷，也不過是付諸一笑，轉身沒入煙雨之中。相濡以沫，不如相忘於江湖。\n\n【結局達成：雲淡風輕】',
            choices: [{ text: '重新開始', nextScene: 'intro_prologue' }]
        }
    ];

    /* --- 遊戲引擎邏輯 --- */
    let gameState = { sceneId: 'intro_prologue', history: [] }; // 從序章開始
    let isTyping = false;
    let currentText = "";
    let typeInterval;
    let currentSceneData = null;
    let autoPlay = false;
    let autoTimer = null;

    const dom = {
        stage: document.getElementById('stage'),
        bgFront: document.getElementById('bg-front'),
        bgBack: document.getElementById('bg-back'),
        uiLayer: document.getElementById('ui-layer'),
        dialogueBox: document.getElementById('dialogue-box'),
        nameTag: document.getElementById('name-tag'),
        dialogueText: document.getElementById('dialogue-text'),
        nextCursor: document.getElementById('next-cursor'),
        choicesOverlay: document.getElementById('choices-overlay'),
        coverScreen: document.getElementById('cover-screen'),
        logWindow: document.getElementById('log-window'),
        logContent: document.getElementById('log-content'),
        toast: document.getElementById('toast'),
        btnAuto: document.getElementById('btn-auto'),
        chapterOverlay: document.getElementById('chapter-overlay'),
        chapterText: document.getElementById('chapter-text')
    };

    function startGame() {
        gameState.sceneId = 'intro_prologue';
        gameState.history = [];
        dom.coverScreen.style.display = 'none';
        dom.uiLayer.style.display = 'block';
        playScene(gameState.sceneId);
    }

    function returnToCover() {
        stopAuto();
        dom.uiLayer.style.display = 'none';
        dom.coverScreen.style.display = 'flex';
        // 使用上方定義的變數設定封面
        dom.coverScreen.style.backgroundImage = `url('${coverBgImage}')`;
    }

    function playScene(sceneId) {
        if (sceneId === 'start') { returnToCover(); return; }

        const scene = story.find(s => s.id === sceneId);
        if (!scene) { console.error("Scene not found:", sceneId); return; }

        currentSceneData = scene;
        gameState.sceneId = sceneId;

        // 章節轉場動畫
        if (scene.type === 'chapter') {
            dom.chapterText.textContent = scene.title;
            dom.chapterOverlay.style.display = 'flex';
            dom.chapterOverlay.style.opacity = 1;
            
            // 2秒後淡出
            setTimeout(() => {
                dom.chapterOverlay.style.opacity = 0;
                setTimeout(() => {
                    dom.chapterOverlay.style.display = 'none';
                }, 1000);
            }, 2000);
        }

        // 背景切換
        if (dom.bgFront.style.backgroundImage !== `url("${scene.background}")`) {
            dom.bgBack.style.backgroundImage = dom.bgFront.style.backgroundImage;
            dom.bgBack.style.opacity = 1;
            dom.bgFront.style.backgroundImage = `url('${scene.background}')`;
            dom.bgFront.style.opacity = 0;
            void dom.bgFront.offsetWidth;
            dom.bgFront.style.opacity = 1;
            setTimeout(() => { dom.bgBack.style.opacity = 0; }, 1000);
        }

        parseAndDisplayText(scene.text);
    }

    function parseAndDisplayText(rawText) {
        let name = "";
        let text = rawText;
        const nameMatch = rawText.match(/^\*\*(.*?)(?:：|:)\*\*\s*(.*)/s);
        if (nameMatch) {
            name = nameMatch[1];
            text = nameMatch[2];
        }

        if (name) {
            dom.nameTag.textContent = name;
            dom.nameTag.style.display = 'block';
            dom.nameTag.style.background = name === '皇帝' ? 'linear-gradient(to right, #D4AF37, #8B6914)' : 'linear-gradient(to right, #8c1d40, #5a1025)';
            dom.nameTag.style.color = name === '皇帝' ? '#000' : '#FFD700';
            dom.nameTag.style.borderColor = name === '皇帝' ? '#FFFFFF' : '#FFD700';
        } else {
            dom.nameTag.style.display = 'none';
        }

        gameState.history.push({ name: name || '', text: text });
        updateLogUI();
        startTyping(text);
    }

    function startTyping(text) {
        isTyping = true;
        currentText = text;
        dom.dialogueText.innerHTML = '';
        dom.nextCursor.style.display = 'none';
        dom.choicesOverlay.style.display = 'none';

        let index = 0;
        const speed = 100; 

        clearInterval(typeInterval);
        typeInterval = setInterval(() => {
            if (index < text.length) {
                const char = text.charAt(index);
                if (char === '\n') {
                    dom.dialogueText.innerHTML += '<br>';
                } else {
                    dom.dialogueText.innerHTML += char;
                }
                index++;
                dom.dialogueText.scrollTop = dom.dialogueText.scrollHeight;
            } else {
                finishTyping();
            }
        }, speed);
    }

    function finishTyping() {
        clearInterval(typeInterval);
        isTyping = false;
        dom.dialogueText.innerHTML = currentText.replace(/\n/g, '<br>');
        
        if (currentSceneData.choices) {
            // 文字顯示完畢後，延遲 1 秒再顯示選項
            setTimeout(() => {
                showChoices(currentSceneData.choices);
            }, 1000);
        } else if (currentSceneData.nextScene) {
            dom.nextCursor.style.display = 'block';
            if (autoPlay) {
                autoTimer = setTimeout(() => {
                    playScene(currentSceneData.nextScene);
                }, 2000 + (currentText.length * 50));
            }
        }
    }

    function handleInteraction(event) {
        if (event && (event.target.closest('.sys-btn') || event.target.closest('.choice-btn'))) return;

        if (isTyping) {
            finishTyping();
        } else {
            if (!currentSceneData.choices && currentSceneData.nextScene) {
                playScene(currentSceneData.nextScene);
            }
        }
    }

    function showChoices(choices) {
        dom.choicesOverlay.innerHTML = '';
        dom.choicesOverlay.style.display = 'flex';
        if (autoPlay) toggleAuto();

        choices.forEach(choice => {
            const btn = document.createElement('div');
            btn.className = 'choice-btn';
            btn.textContent = choice.text;
            btn.onclick = (e) => {
                e.stopPropagation();
                dom.choicesOverlay.style.display = 'none';
                playScene(choice.nextScene);
            };
            dom.choicesOverlay.appendChild(btn);
        });
    }

    function saveGame() {
        const saveSlot = { sceneId: gameState.sceneId, history: gameState.history, date: new Date().toLocaleString() };
        localStorage.setItem('dragon_embers_deep_save', JSON.stringify(saveSlot));
        showToast("遊戲進度已儲存");
    }

    function loadGame() {
        const saveString = localStorage.getItem('dragon_embers_deep_save');
        if (saveString) {
            const saveSlot = JSON.parse(saveString);
            gameState = saveSlot;
            dom.coverScreen.style.display = 'none';
            dom.uiLayer.style.display = 'block';
            playScene(gameState.sceneId);
            updateLogUI();
            showToast("已讀取進度");
        } else {
            alert("沒有找到存檔紀錄！");
        }
    }

    function loadGameInGame() {
        if(confirm("確定要讀取之前的進度嗎？目前的未保存進度將遺失。")) loadGame();
    }

    function toggleLog() {
        const isHidden = dom.logWindow.style.display === 'none' || dom.logWindow.style.display === '';
        dom.logWindow.style.display = isHidden ? 'flex' : 'none';
    }

    function updateLogUI() {
        dom.logContent.innerHTML = gameState.history.map(h => `
            <div class="log-entry">
                <div class="log-name">${h.name}</div>
                <div class="text-gray-400">${h.text}</div>
            </div>
        `).join('');
        dom.logContent.scrollTop = dom.logContent.scrollHeight;
    }

    function toggleAuto() {
        autoPlay = !autoPlay;
        dom.btnAuto.style.backgroundColor = autoPlay ? '#8c1d40' : 'rgba(0,0,0,0.6)';
        dom.btnAuto.style.color = autoPlay ? 'white' : '#a0aec0';
        dom.btnAuto.style.borderColor = autoPlay ? '#FFD700' : '#4a5568';
        
        if (autoPlay && !isTyping && !currentSceneData.choices) handleInteraction();
        else if (!autoPlay) clearTimeout(autoTimer);
    }

    function stopAuto() {
        autoPlay = false;
        clearTimeout(autoTimer);
        dom.btnAuto.style.backgroundColor = 'rgba(0,0,0,0.6)';
        dom.btnAuto.style.color = '#a0aec0';
        dom.btnAuto.style.borderColor = '#4a5568';
    }

    function showToast(msg) {
        dom.toast.textContent = msg;
        dom.toast.style.opacity = 1;
        setTimeout(() => { dom.toast.style.opacity = 0; }, 2000);
    }

    // 初始化封面
    // 使用上方定義的變數設定封面
    dom.coverScreen.style.backgroundImage = `url('${coverBgImage}')`;

</script>
</body>
</html>